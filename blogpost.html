<p>I was asked over the weekend by a client to add a new feature to their website. This client runs an online shopping cart and like other small vendors will run out of stock on a particular item every so often. They wanted a way for a visitor to sign up to be notified when that item was back in stock. While this seems like a fairly easy feature to add I had a couple of self imposed requirements.</p>

<p>All we need from the user is their name and email address. As a visitor I really don't like being taken away from my browsing expirience for simple forms like this. I decided that this form would need to be a modal dialog box. To do this I am going to use <a href="http://jqueryui.com/">jQuery UI</a> because It flat out rocks! I also need this information to be stored in a database so that we can export this info by product. The client will then take these email addresses over to Constant Contact and notify their customers that the product is back in stock.</p>

<p>To show you how I did this I created a little one page shopping cart. In our our sample application I have a book store and on this page I have 3 Flex books, 1 of which is out of stock. If the book is out of stock I have a button for the user to click on.</p>

<p><img src="http://www.danvega.org/blog/images/shoppingcart.png" /></p>

<p>When the user clicks on the In stock notifications they will see the following form pop up in a modal window. When the user submits the form they will see a small transition and then the success message below.</p>

<p><img src="http://www.danvega.org/blog/images/dialog.png"/></p>
<p><img src="http://www.danvega.org/blog/images/success.png"/></p>

<more/>

<p>So lets go ahead and build this small application out. I have posted the entire sample on my <a href="https://github.com/cfaddict/">github account</a> so feel free to download it and follow along. First we will create our one page shopping cart. To do so I will be using <a href="http://twitter.github.com/bootstrap/">Boostrap</a>, if you haven't had a chance to check it out I highly recommend it.</p>

<textarea class="brush: html">
<!DOCTYPE html>
<html>
<head>
    <title></title>
	<meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1" />	
	<meta name="description" content="" />
	<meta name="keywords" content="" />

	<link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/stylesheet.css" type="text/css"/>
	<link rel="stylesheet" href="assets/css/flick/jquery-ui-1.8.16.custom.css" type="text/css"/>

	<!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
	<script type="text/javascript">
		$(function() {
					
		});
	</script>
</head>
<body>

	<div class="container">

		<div class="content">
			<div class="page-header">
				<h1>Shopping Cart <small>Flex Book Store</small></h1>
			</div>

			<ul class="breadcrumb">
				<li><a href="#">Home</a> <span class="divider">/</span></li>
				<li><a href="#">Products</a> <span class="divider">/</span></li>
				<li><a href="#">Books</a> <span class="divider">/</span></li>
				<li class="active">Flex</li>
			</ul>		

			<div class="row">
				<div class="span10">			
					<h2>Flex Books</h2>

					<div class="product">
						<img src="assets/images/android_w_flex.jpg" width="100">
						<div class="details">
							<h2>Android Applications with Flex 4.5</h2>
							List Price: $24.99<br/>
							<span class="sale">Price: $21.36</span><br/>
							You Save: $3.63 (15%)<br/>
							In Stock: Yes<br/>
							<div class="buttons">
								<button class="btn primary">Add To Cart</button>
							</div>
						</div>
					</div>

					<div class="product">
						<img src="assets/images/flex4cookbook.jpg" width="100">
						<div class="details">
							<h2>Flex 4 Cookbook</h2>
							List Price: $49.99<br/>
							<span class="sale">Price: $31.46</span><br/>
							You Save: $18.50 (37%)<br/>
							In Stock: No<br/>
							<div class="buttons">
								<button class="btn primary">Add To Cart</button>
								<button id="notifyme" class="btn danger notifyme" data-item="1234">In Stock Notifications</button>
							</div>
						</div>
					</div>					

					<div class="product last">
						<img src="assets/images/tfts.jpg" width="100">
						<div class="details">
							<h2>Adobe Flex 4: Training from the Source</h2>
							List Price: $49.99<br/>
							<span class="sale">Price: $31.49</span><br/>
							You Save: $18.50 (37%)<br/>
							In Stock: Yes<br/>
							<div class="buttons">
								<button class="btn primary">Add To Cart</button>
							</div>
						</div>
					</div>

				</div>
				<div class="span4">
					<h3>Categories</h3>
					<ul class="categories">
						<li><a href="#">ColdFusion</a></li>
						<li><a href="#">Java</a></li>
						<li><a href="#">PHP</a></li>
						<li><a href="#" class="active">Flex</a></li>
						<li><a href="#">Groovy</a></li>
						<li><a href="#">Rails</a></li>
						<li><a href="#">Python</a></li>
						<li><a href="#">JavaScript</a></li>
						<li><a href="#">CSS</a></li>
						<li><a href="#">jQuery</a></li>
						<li><a href="#">Git</a></li>
						<li><a href="#">ActionScript</a></li>
						<li><a href="#">.NET</a></li>
						<li><a href="#">Tomcat</a></li>
						<li><a href="#">Hibernate</a></li>																		
					</ul>
				</div>
			</div>
		</div>

		<footer>
			<p>This is a sample application showing off Bootstrap/jQuery/jQuery-ui and was created by Dan Vega</p>
		</footer>

	</div>


</body>
</html>
</textarea>

<p>Now that you have your page setup we need to create the modal dialog window. To do this we are going to use a mix of plain html/css and some JavaScript magic provided to us by jQuery UI. First we create the form and I just placed mine before the ending body tag. The only trick here is we need to hide this form by default and to do so we can just set the display to none. We have a success message that by default is hidden and we will display to the user when the form has been submitted. You will also notice that we have no submit button on this form. jQuery UI actually gives us a nice API to add some buttons to our dialog box so will take advantage of that.</p>

<textarea class="brush: html">
<div id="dialog" title="In Stock Notifications" style="display:none;">

	<div class="alert-message success" style="display:none;margin:20px;">
    	<p><strong>Thank You!</strong> We will notify you when this product becomes available.</p>
  	</div>

	<form id="frmNotifyMe">
		<p>If you would like to be notified when this product is in stock please enter your information below. We will only use this info to contact your regarding the availability of this product.</p>

		<p class="required">All Fields Required</p>
		<div class="clearfix">
			<label for="xlInput">Full Name</label>
			<div class="input">
				<input class="xlarge" id="name" name="name" size="30" type="text">
			</div>
		</div>
		<div class="clearfix">
			<label for="xlInput">Email Address</label>
			<div class="input">
				<input class="xlarge" id="email" name="email" size="30" type="text">
			</div>
		</div>
	</form>
	
</div>
</textarea>

<p>Now that we have our form built we need to wire it up to the button. We have a class of notifyme on our button so we will just add a click event listener to it. In that function we will create our modal dialog using jquery ui. If you need to find out what options are available just <a href="http://jqueryui.com/demos/dialog/">check out the docs</a>. We have a cancel button which basically just calls close method and a submit button which will handle all of our magic.</p>

<textarea class="brush: javascript">
<script type="text/javascript">
	$(function() {

		$("#notifyme").click(function(e){

			$("#dialog").dialog({
				width:500,
				modal:true,
				position: 'center',
				resizable: false,
				buttons: {
					Submit : function(){

					},
					Cancel: function() {
						$( this ).dialog( "close" );
					}
				},
				close : function(event,ui){
				}
			});

		});
				
	});
	
</script>
</textarea>

<p>Next we need to wire up our submit button. First we need to figure out what product we are talking about. To do this we can use jQuery's data() method to grab the item number. Before we can go ahead and submit this data we need to validate the data entered by the user. I want to make sure that they enter something for the name and that the email address is a valid email. If it fails I just change the 'All Fields Required' message to something else. You could probably get fancy here but I didn't see the need for it.

<textarea class="brush: javascript">
<script type="text/javascript">
	$(function() {

		$(".notifyme").click(function(e){
			
			var id = $(this).data('item');
			var name = $('#name');
			var email = $('#email');

			$("#dialog").dialog({
				width:500,
				modal:true,
				position: 'center',
				resizable: false,
				buttons: {
					"Submit" : function(){
						
						// if the data is valid add our notification to the db
						if( validate(name,email) ){

							// ajax post
															
						} else {
							$('.required').html('Please enter your full name and a valid email address.');
						}

					},
					Cancel: function() {
						$( this ).dialog( "close" );
					}
				},
				close : function(event,ui){
				}
			});

		});
				
	});
	
	// validate user input
	function validate(name,email) {
		if( name.val().length > 0 && isValidEmail(email.val()) ){
			return true;
		}
		return false;
	}	

	// validates email address
	function isValidEmail(str){
			var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;  
			return emailPattern.test(str);  			
	}
</script>
</textarea>

<p>Now comes the fun part. We need to create an ajax post when the submit button is clicked and our data has been validated. We will call a local cfc with a method called addNotification, more on that in a moment. Our method will take a product id, name and email. We can pass those into our method using the data attribute of jQuery's Ajax method. Finally once the notification has been added we need to tell our user that something happened. What I am going to do is remove the buttons from our dialog box, hide the form and then display that success message that was hidden. You will also notice that we have added some logic to our close function. When the user exits our form by clicking the x button we don't want to retain any information on the form. So if I type Dan in the name box and close I would expect to see an empty form when I open it back up. This gives it that feel that you are creating a new instance of the form when you click on the button.</p>

<textarea class="brush: javascript">
<script type="text/javascript">
	$(function() {

		$(".notifyme").click(function(e){
			
			var id = $(this).data('item');
			var name = $('#name');
			var email = $('#email');

			$("#dialog").dialog({
				width:500,
				modal:true,
				position: 'center',
				resizable: false,
				buttons: {
					"Submit" : function(){
						
						// if the data is valid add our notification to the db
						if( validate(name,email) ){

							// ajax post
							$.ajax({
								url: 'NotifyMe.cfc?method=addNotification',
								data: {
									id: id,
									name: name.val(),
									email: email.val()	
								},
								type: 'post',
								dataType: 'json',
								success: function(){
									// hide the form + buttons and show the success message
									$('#dialog').dialog('option','buttons','');
									$('#frmNotifyMe').slideToggle();
									$('.success').slideToggle();
								},
								error: function(xhr, textStatus, errorThrown){
								
								}
							});
															
						} else {
							$('.required').html('Please enter your full name and a valid email address.');
						}

					},
					Cancel: function() {
						$( this ).dialog( "close" );
					}
				},
				close : function(event,ui){
					$('#name').val('');
					$('#email').val('');
					$('.required').html('All Fields Required');					
				}
			});

		});
				
	});
	
	// validate user input
	function validate(name,email) {
		if( name.val().length > 0 && isValidEmail(email.val()) ){
			return true;
		}
		return false;
	}	

	// validates email address
	function isValidEmail(str){
			var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;  
			return emailPattern.test(str);  			
	}
</script>
</textarea>

<p>Finally we have our component. Nothing special going on here, just a method that accepts an id, name and email. We will take this data and save it to a database table called notifications. If you look in the downloads I have sample SQL script for MSSQL. In the administrator for the cart I built a little function that would give them a unique list of products where exported = 0. They can select that list and export a list of users that can be sent to constact contact. Those users are now set to exported so they will not be notified again. If anyone is interested I can follow up this post with how I did that but it is pretty basic.</p>

<textarea class="brush: coldfusion">
component {

	remote void function addNotification(Numeric id,String name,String email){
		var q = new Query(datasource="notifyme");
		q.setSQL("
			INSERT INTO notifications
			(pid,name,email,dateCreated,exported)
			VALUES
			(:pid,:name,:email,#now()#,0);
		");

		q.addParam(name="pid",value="#arguments.id#",cfsqltype="integer");
		q.addParam(name="name",value="#arguments.name#",cfsqltype="varchar");
		q.addParam(name="email",value="#arguments.email#",cfsqltype="varchar");

		try {
			q.execute();
		} catch(any e){
			// error handling
		}
		
	}

}
</textarea>

<p>That wasn't so hard now was it. Pretty simple but as you can see there is some effort that goes into to this to make sure that every step of the way is a nice seamless experience for the user. If you have any questions and or suggestion please feel free to share them.</p>
